// Smart CS Dashboard - Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  password      String
  role          UserRole @default(AGENT)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  assignedCalls Call[]   @relation("AssignedCalls")
  assignedMails Mail[]   @relation("AssignedMails")
  notes         Note[]

  @@map("users")
}

enum UserRole {
  ADMIN
  SUPERVISOR
  AGENT
}

// ==================== CUSTOMER ====================

model Customer {
  id              String   @id @default(cuid())
  ikasCustomerId  String?  @unique  // Ikas'taki müşteri ID

  email           String   @unique
  phone           String?
  firstName       String
  lastName        String

  // Metadata
  totalOrders     Int      @default(0)
  totalSpent      Decimal  @default(0) @db.Decimal(10, 2)
  lifetimeValue   Decimal  @default(0) @db.Decimal(10, 2)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastContactAt   DateTime?

  // Relations
  orders          Order[]
  calls           Call[]
  mails           Mail[]
  returns         Return[]
  notes           Note[]

  @@map("customers")
  @@index([email])
  @@index([phone])
  @@index([ikasCustomerId])
}

// ==================== ORDER (IKAS) ====================

model Order {
  id                String      @id @default(cuid())
  ikasOrderId       String      @unique  // Ikas'taki sipariş ID
  orderNumber       String      @unique  // Sipariş numarası (#1234)

  customerId        String
  customer          Customer    @relation(fields: [customerId], references: [id])

  status            OrderStatus
  paymentStatus     PaymentStatus
  fulfillmentStatus FulfillmentStatus

  totalAmount       Decimal     @db.Decimal(10, 2)
  currency          String      @default("TRY")

  shippingAddress   Json?       // Address object
  billingAddress    Json?       // Address object

  items             OrderItem[]

  orderDate         DateTime
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  calls             Call[]
  mails             Mail[]
  returns           Return[]
  notes             Note[]

  @@map("orders")
  @@index([customerId])
  @@index([ikasOrderId])
  @@index([orderNumber])
  @@index([orderDate])
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  ikasProductId String
  productName   String
  variantName   String?
  sku           String?

  quantity      Int
  price         Decimal @db.Decimal(10, 2)
  totalPrice    Decimal @db.Decimal(10, 2)

  imageUrl      String?

  @@map("order_items")
  @@index([orderId])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  SHIPPED
  DELIVERED
}

// ==================== CALL (TELEFON) ====================

model Call {
  id              String     @id @default(cuid())

  customerId      String?
  customer        Customer?  @relation(fields: [customerId], references: [id])

  orderId         String?
  order           Order?     @relation(fields: [orderId], references: [id])

  assignedToId    String?
  assignedTo      User?      @relation("AssignedCalls", fields: [assignedToId], references: [id])

  // Çağrı Bilgileri
  direction       CallDirection
  phoneNumber     String
  duration        Int?       // saniye cinsinden
  status          CallStatus

  // AI İşlemleri
  isAiHandled     Boolean    @default(false)
  audioUrl        String?    // Ses kaydı URL
  transcriptText  String?    @db.Text
  aiSummary       String?    @db.Text
  aiSentiment     String?    // POSITIVE, NEUTRAL, NEGATIVE

  // Twilio Integration
  twilioCallSid   String?    @unique
  twilioStatus    String?

  // Verimor Integration
  verimorCallId   String?    @unique

  // Eşleştirme
  isMatchedWithOrder Boolean  @default(false)
  matchConfidence    Float?   // 0-1 arası AI güven skoru

  callStartedAt   DateTime?
  callEndedAt     DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  notes           Note[]

  @@map("calls")
  @@index([customerId])
  @@index([orderId])
  @@index([phoneNumber])
  @@index([callStartedAt])
  @@index([status])
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  QUEUED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
  CANCELLED
}

// ==================== MAIL ====================

model Mail {
  id              String     @id @default(cuid())

  customerId      String?
  customer        Customer?  @relation(fields: [customerId], references: [id])

  orderId         String?
  order           Order?     @relation(fields: [orderId], references: [id])

  assignedToId    String?
  assignedTo      User?      @relation("AssignedMails", fields: [assignedToId], references: [id])

  ticketId        String?    // Link to ticket for grouping

  // Mail Bilgileri
  direction       MailDirection
  fromEmail       String
  toEmail         String
  subject         String
  bodyText        String     @db.Text
  bodyHtml        String?    @db.Text

  status          MailStatus
  priority        MailPriority @default(NORMAL)

  // AI İşlemleri
  isAiAnalyzed    Boolean    @default(false)
  aiCategory      String?    // ORDER_INQUIRY, COMPLAINT, RETURN_REQUEST, etc.
  aiSummary       String?    @db.Text
  aiSentiment     String?

  // Sipariş Eşleştirme
  suggestedOrderIds String[] // AI'ın önerdiği sipariş ID'leri
  isMatchedWithOrder Boolean @default(false)
  matchConfidence    Float?
  matchedOrderNumber String?  // Matched order number
  matchedReturnId    String?  // Matched return ID

  // Mail Metadata
  messageId       String?    @unique
  inReplyTo       String?
  mailReferences  String[]
  attachments     Json?      // Attachment metadata array
  labels          String[]   // Gmail labels / IMAP folders
  flags           String[]   // IMAP flags (SEEN, FLAGGED, etc.)

  // Soft delete
  deletedAt       DateTime?

  receivedAt      DateTime?
  sentAt          DateTime?
  respondedAt     DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  notes           Note[]

  @@map("mails")
  @@index([customerId])
  @@index([orderId])
  @@index([fromEmail])
  @@index([status])
  @@index([receivedAt])
  @@index([ticketId])
  @@index([deletedAt])
  @@index([assignedToId])
}

enum MailDirection {
  INBOUND
  OUTBOUND
}

enum MailStatus {
  NEW
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum MailPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ==================== RETURN (İADE - BOOMERANG) ====================

model Return {
  id                String       @id @default(cuid())

  customerId        String
  customer          Customer     @relation(fields: [customerId], references: [id])

  orderId           String
  order             Order        @relation(fields: [orderId], references: [id])

  boomerangReturnId String?      @unique

  returnNumber      String       @unique
  status            ReturnStatus
  reason            String
  reasonDetail      String?      @db.Text
  source            String       @default("portal") // portal, ikas, manual

  items             ReturnItem[]

  totalRefundAmount Decimal      @db.Decimal(10, 2)
  refundStatus      RefundStatus

  requestedAt       DateTime     @default(now())
  approvedAt        DateTime?
  completedAt       DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  notes             Note[]
  timeline          ReturnTimeline[]

  @@map("returns")
  @@index([customerId])
  @@index([orderId])
  @@index([status])
}

model ReturnItem {
  id            String  @id @default(cuid())
  returnId      String
  return        Return  @relation(fields: [returnId], references: [id], onDelete: Cascade)

  productName   String
  variantName   String?
  quantity      Int
  refundAmount  Decimal @db.Decimal(10, 2)

  @@map("return_items")
  @@index([returnId])
}

enum ReturnStatus {
  REQUESTED
  PENDING_APPROVAL
  APPROVED
  REJECTED
  IN_TRANSIT
  RECEIVED
  COMPLETED
  CANCELLED
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model ReturnTimeline {
  id          String   @id @default(cuid())
  returnId    String
  return      Return   @relation(fields: [returnId], references: [id], onDelete: Cascade)

  eventType   String   // created, status_changed, note_added, approved, rejected, etc.
  eventData   Json?    // Additional event metadata
  description String?  @db.Text
  createdBy   String?  // User ID who triggered the event
  createdAt   DateTime @default(now())

  @@map("return_timeline")
  @@index([returnId])
  @@index([createdAt])
}

// ==================== NOTES (GENEL NOTLAR) ====================

model Note {
  id          String   @id @default(cuid())

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])

  orderId     String?
  order       Order?    @relation(fields: [orderId], references: [id])

  callId      String?
  call        Call?     @relation(fields: [callId], references: [id])

  mailId      String?
  mail        Mail?     @relation(fields: [mailId], references: [id])

  returnId    String?
  return      Return?   @relation(fields: [returnId], references: [id])

  content     String    @db.Text
  isInternal  Boolean   @default(true) // Müşteriye gösterilmeyecek notlar

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("notes")
  @@index([customerId])
  @@index([orderId])
}

// ==================== KPI & ANALYTICS ====================

model DailyMetric {
  id              String   @id @default(cuid())
  date            DateTime @unique @db.Date

  // Call Metrics
  totalCalls      Int      @default(0)
  answeredCalls   Int      @default(0)
  missedCalls     Int      @default(0)
  aiHandledCalls  Int      @default(0)
  avgCallDuration Float    @default(0)

  // Mail Metrics
  totalMails      Int      @default(0)
  resolvedMails   Int      @default(0)
  avgResponseTime Float    @default(0) // dakika cinsinden

  // AI Performance
  aiMatchAccuracy Float    @default(0) // 0-100
  aiCallSuccess   Float    @default(0) // 0-100

  // Order Metrics
  totalOrders     Int      @default(0)
  totalRevenue    Decimal  @default(0) @db.Decimal(10, 2)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("daily_metrics")
  @@index([date])
}

// ==================== SETTINGS ====================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
  @@index([key])
}

// ==================== APP USERS (SUPABASE AUTH) ====================

model AppUser {
  id                    String   @id  // Matches Supabase Auth user.id
  email                 String   @unique
  name                  String
  role                  UserRole @default(AGENT)
  requirePasswordChange Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("app_users")
}

// ==================== TICKETS ====================

model Ticket {
  id              String        @id @default(cuid())
  ticketNumber    String        @unique @default(cuid())

  subject         String
  customerEmail   String
  customerName    String?

  orderNumber     String?       // Linked order number
  returnId        String?       // Linked return ID

  assignedTo      String?       // User ID
  status          TicketStatus  @default(OPEN)
  priority        TicketPriority @default(NORMAL)

  tags            String[]      // Auto-detected tags

  lastActivityAt  DateTime      @default(now())
  closedAt        DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  events          TicketEvent[]
  notes           TicketNote[]

  @@map("tickets")
  @@index([customerEmail])
  @@index([status])
  @@index([lastActivityAt])
  @@index([assignedTo])
}

model TicketEvent {
  id          String   @id @default(cuid())
  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  eventType   String   // ticket_created, mail_received, reply_sent, status_changed, etc.
  eventData   Json?    // Additional event metadata

  createdAt   DateTime @default(now())

  @@map("ticket_events")
  @@index([ticketId])
  @@index([createdAt])
}

model TicketNote {
  id          String   @id @default(cuid())
  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  author      String   // User ID or email
  content     String   @db.Text
  isInternal  Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ticket_notes")
  @@index([ticketId])
}

enum TicketStatus {
  OPEN
  WAITING_CUSTOMER
  WAITING_INTERNAL
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ==================== JOB QUEUE ====================

model JobQueue {
  id            String     @id @default(cuid())

  jobType       String     // FETCH_IKAS_ORDER, SYNC_RETURNS, etc.
  payload       Json       // Job-specific data

  status        JobStatus  @default(PENDING)
  priority      Int        @default(5)  // 1=highest, 10=lowest

  attempts      Int        @default(0)
  maxAttempts   Int        @default(3)
  errorMessage  String?    @db.Text

  scheduledAt   DateTime   @default(now())
  startedAt     DateTime?
  completedAt   DateTime?

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@map("job_queue")
  @@index([status])
  @@index([priority])
  @@index([scheduledAt])
  @@index([jobType])
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ==================== IKAS ORDER CACHE ====================

model IkasOrderCache {
  id          String   @id @default(cuid())
  mailId      String?  // Linked mail ID
  orderNumber String   @unique

  orderData   Json     // Cached order data from İkas

  fetchedAt   DateTime @default(now())
  expiresAt   DateTime // Cache expiry time

  @@map("ikas_order_cache")
  @@index([orderNumber])
  @@index([expiresAt])
}
